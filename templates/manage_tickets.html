<!doctype html>
<html>
    <head>
        <title>HBUHSD Help Desk</title>
        <script type="text/javascript" src="/static/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="/static/js/jquery-ui-1.8.20.custom.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap-modal.js"></script>
        <script type="text/javascript" src="/static/js/underscore-min.js"></script>
        <script type="text/javascript" src="/static/js/backbone-min.js"></script>
        <script type="text/javascript" src="/static/js/handlebars.js"></script>

        <link rel="shortcut icon" href="/static/favicon.ico" />
        <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/static/css/bootstrap-responsive.min.css" />
        <link rel="stylesheet" href="/static/css/jquery-ui-1.8.20.custom.css" />

        {% raw %}
        <script id="ticketListTemplate" type="text/x-handlebars-template">
            <a href="#">
                <strong>{{ticket.ticketType}}</strong>
                {{ticket.ticketSubmittedBy}}
                {{ticket.ticketSubmittedOn}}
                <i class="{{icon}} pull-right favMe"></i>
            </a>
        </script>

        <script id="ticketNotesTemplate" type="text/x-handlebars-template">
        </script>

        <script id="singleTicketTemplate" type="text/x-handlebars-template">
            <div class="span4">
                <h3>Ticket#: {{ticket.id}}</h3>
                <ul>
                    <li>Submitted By: {{ticket.ticketSubmittedBy}}</li>
                    <li>Submitted On: {{ticket.ticketSubmittedOn}}</li>
                </ul>
            </div>
            <div class="span3">
                <h3>Notes:</h3>
                <ul id="ticketNotes">
                    {{#each ticket.ticketNotes}}
                    <li>{{this}}</li>
                    {{/each}}
                    <li id="addNote"><h6>Add Note...</h6></li>
                </ul>
            </div>
        </script>
        {% endraw%}

        <script>
            var Ticket = Backbone.Model.extend({
                urlRoot: "/ticket",
                elevate: function(){
                    return true;
                },
                closeTicket: function(){
                    return true;
                },
                addNote: function(){
                    return true;
                },
                toggleStar: function(){
                    var self = this;
                    self.save({
                        ticketStarred: !self.get("ticketStarred"),
                    });
                },
                addNote: function(note){
                    var self = this;
                    self.save({
                        ticketNotes: self.get("ticketNotes").push(note),
                    });
                },
            });

            var Tickets = Backbone.Collection.extend({
                model: Ticket,
                url: '/tickets',
                initialize: function(){
                },
                closed: function(){
                    return true;
                },
                open: function(){
                    return true;
                },
            });

            //Single ticket view in window
            var SingleTicket = Backbone.View.extend({
                events: {
                    "dblclick #addNote": "getNote",
                    "keypress #newNote": "addNote",
                },
                initialize: function(){
                    var self = this;
                    self.model.bind('change', self.render, self);
                },
                render: function(){
                    var self = this;
                    var thisTicket = self.model.attributes;
                    var source = $('#singleTicketTemplate').html();
                    var template = Handlebars.compile(source);
                    var context = {
                        ticket: thisTicket,
                    }
                    var source = template(context);
                    $(self.el).html(source);
                    return self
                },
                getNote: function(){
                    console.log('addNote...');
                    var self = this;
                    $('#addNote', self.el).remove();
                    $('#ticketNotes', self.el).append('<li id="newNoteList"><input id="newNote" type="text" class="input" /></li>');
                },
                addNote: function(e){
                    var self = this;
                    var note = $('#newNote', self.el).val();
                    if(!note || e.keyCode !== 13){
                        return;
                    }
                    self.model.addNote(note);
                    $('#newNoteList', self.el).remove();
                    $('#ticketNotes', self.el).append('<li id="addNote"><h6>Add Note...</h6></li>');
                },
            });

            //Ticket view in the list
            var TicketView = Backbone.View.extend({
                tagName: "li",
                className: "ticketListItem",
                events: {
                    //"click .closeTicket": "closeTicket",
                    "click": "expandTicket",
                    "click .favMe": "toggleStar",
                },
                initialize: function(){
                    this.model.bind('change', this.render, this);
                },
                render: function(){
                    var self = this;
                    var starred = 'icon-star-empty';
                    var thisTicket = self.model.attributes;
                    if (thisTicket.ticketStarred){
                        starred = 'icon-star';
                    }
                    console.log(thisTicket);
                    var source = $('#ticketListTemplate').html();
                    var template = Handlebars.compile(source);
                    var context = {
                        ticket: thisTicket,
                        icon: starred,
                    }
                    var source = template(context);
                    $(self.el).html(source);
                    return self;
                },
                contextMenu: function(e){
                    e.preventDefault();
                    console.log('contextMenu...');
                },
                toggleStar: function(){
                    var self = this;
                    self.model.toggleStar();
                },
                expandTicket: function(){
                    var self = this;
                    console.log('expandTicket...');
                    $('.ticketListItem').each(function(){
                        $(this).removeClass('active');
                    });
                    $(self.el).addClass('active');
                    var thisTicket = new SingleTicket({
                        model: this.model,
                    });
                    $('#layoutSingleTicket').html(thisTicket.render().el);
                },
                closeTicket: function(){
                    console.log('closeTicket...');
                },
            });

            //Base application view
            var HelpDesk = Backbone.View.extend({
                tickets: new Tickets(),
                initialize: function(options){
                    var self = this;
                    self.tableHeader = "<h3>Open Tickets:</h3>";
                    self.columnHeaders = "<tr>\
                        <th>SubmittedBy</th>\
                        <th>Type</th>\
                        <th>User</th>\
                        <th>Room</th>\
                        <th>SubmittedOn</th>\
                        <th>Close</th>\
                    </tr>";
                    self.delegateEvents();
        
                    self.tickets.bind('add', self.addOne, self);
                    self.tickets.bind('reset', self.addAll, self);
                    self.tickets.bind('all', self.render, self);
        
                    self.tickets.fetch();
                },
                render: function(){
                    var self = this;
                },
                addOne: function(ticket){
                    var self = this;
                    var view = new TicketView({
                        model: ticket,
                    });
                    $('#layoutTicketList ul', self.el).append(view.render().el);
                },
                addAll: function(){
                    this.tickets.each(this.addOne);
                },
            });

            $(document).ready(function(){
                manageTickets = new HelpDesk({el: $('table')});
            });
        </script>
    </head>
    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <a class="brand" href="#">HBUHSD Help Desk - Ticket Management</a>
                <ul class="nav">
                    <li class="divider-vertical"></li>
                </ul>
            </div>
        </div>
        <div class="container" style="margin-top:50px;">
            <div class="row" style="text-align:center;">
                Title
            </div>
            <div class="row">
                <div id="layoutSingleTicket" class="span8">Single Ticket</div>
                <div id="layoutTicketList" class="span4">
                    <span><h3>Tickets</h3></span>
                    <ul class="nav nav-pills nav-stacked"></ul>
                </div>
            </div>
            <div class="row">
                <div id="layoutFooter">
                    <div class="footer" style="text-align:center;">
                        <hr>
                        HBUHSD Help Desk via Flask and Twitter Bootstrap on Python/Google App Engine
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

