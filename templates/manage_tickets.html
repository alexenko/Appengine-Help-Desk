<!doctype html>
<html>
    <head>
        <title>HBUHSD Help Desk - {% block title %}{% endblock %}</title>
        <script type="text/javascript" src="/static/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="/static/js/jquery-ui-1.8.20.custom.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap-modal.js"></script>
        <script type="text/javascript" src="/static/js/underscore-min.js"></script>
        <script type="text/javascript" src="/static/js/backbone-min.js"></script>
        <script type="text/javascript" src="/static/js/handlebars.js"></script>

        <link rel="shortcut icon" href="/static/favicon.ico" />
        <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/static/css/bootstrap-responsive.min.css" />
        <link rel="stylesheet" href="/static/css/jquery-ui-1.8.20.custom.css" />

        <script id="ticketListTemplate" type="text/x-handlebars-template">
            <div class="row" id="ticketList">
                <div class="span10">
                    <table class="table table-striped table-condensed">
                        <thead>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </script>

        <script id="ticketViewTemplate" type="text/x-handlebars-template">
        </script>

        <script>
            var Ticket = Backbone.Model.extend({
                elevate: function(){
                    return true;
                },
                closeTicket: function(){
                    return true;
                },
                addNote: function(){
                    return true;
                },
            });

            var Tickets = Backbone.Collection.extend({
                model: Ticket,
                url: '/tickets',
                closed: function(){
                    return true;
                },
                open: function(){
                    return true;
                },
            });

            var SingleTicket = Backbone.View.extend({
                events: {
                    "dblclick .addNote": "addNote",
                },
                initialize: function(){
                    var self = this;
                    self.model.bind('change', self.render, self);
                    self.notesRendered = self.renderNotes();
                },
                render: function(){
                    var self = this;
                    var thisTicket = self.model.attributes;
                    $(self.el).html('<div class="span6 well">'+
                        thisTicket.id+
                        '</div><div class="span3 well addNote">'+
                        self.notesRendered+
                        '</div>'
                        );
                    return self
                },
                addNote: function(){
                    console.log('addNote...');
                },
                renderNotes: function(){
                    console.log('renderNotes...');
                    var self = this;
                    var thisTicket = self.model.attributes;
                    var theseMessages = thisTicket.ticketNotes;
                    var thisHTML = "";
                    for (var i=0;i<=theseMessages.length-1;i++){
                        thisHTML+="<p>"+theseMessages[i]+"</p>";
                    };
        
                    return thisHTML;
                },
            });

            var TicketView = Backbone.View.extend({
                tagName: 'tr',
                events: {
                    "click .closeTicket": "closeTicket",
                    "dblclick": "expandTicket",
                },
                initialize: function(){
                    this.model.bind('change', this.render, this);
                },
                render: function(){
                    var self = this;
                    var thisTicket = self.model.attributes;
                    $(self.el).html("<td>"+thisTicket.ticketSubmittedBy+
                            "</td><td>"+thisTicket.ticketType+
                            "</td><td>"+thisTicket.ticketUserType+
                            "</td><td>"+thisTicket.ticketMacroLocation+
                            "</td><td>"+thisTicket.ticketSubmittedOn+
                            "</td><td>"+"<a class=\"btn btn-primary btn-mini closeTicket\">Close</a>"+
                            "</td>");
                    return self;
                },
                contextMenu: function(e){
                    e.preventDefault();
                    console.log('contextMenu...');
                },
                expandTicket: function(){
                    console.log('expandTicket...');
                    var thisTicket = new SingleTicket({
                        model: this.model,
                    });
                    $('#ticketExpand').html(thisTicket.render().el);
                },
                closeTicket: function(){
                    console.log('closeTicket...');
                },
            });

            var HelpDesk = Backbone.View.extend({
                tickets: new Tickets(),
                initialize: function(options){
                    var self = this;
                    self.tableHeader = "<h3>Open Tickets:</h3>";
                    self.columnHeaders = "<tr>\
                        <th>SubmittedBy</th>\
                        <th>Type</th>\
                        <th>User</th>\
                        <th>Room</th>\
                        <th>SubmittedOn</th>\
                        <th>Close</th>\
                    </tr>";
                    self.delegateEvents();
        
                    self.tickets.bind('add', self.addOne, self);
                    self.tickets.bind('reset', self.addAll, self);
                    self.tickets.bind('all', self.render, self);
        
                    self.tickets.fetch();
                },
                render: function(){
                    var self = this;
                    $('thead', self.el).append(self.tableHeader);
                    $('thead', self.el).append(self.columnHeaders);
                },
                addOne: function(ticket){
                    var self = this;
                    var view = new TicketView({
                        model: ticket,
                    });
                    $('tbody', self.el).append(view.render().el);
                },
                addAll: function(){
                    this.tickets.each(this.addOne);
                },
            });

            $(document).ready(function(){
                manageTickets = new HelpDesk({el: $('table')});
            });
        </script>
    </head>
    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <a class="brand" href="#">HBUHSD Help Desk - Ticket Management</a>
                <ul class="nav">
                    <li class="divider-vertical"></li>
                </ul>
            </div>
        </div>
        <div class="container" style="margin-top:40px;">
            <div class="row">
                <div id="layoutSingleTicket" class="span5">Single Ticket</div>
                <div id="layoutTicketNotes" class="span3">Notes</div>
                <div id="layoutTicketList" class="span4">Ticket List</div>
            </div>
            <div class="row">
                <div id="layoutFooter">
                    <div class="footer" style="text-align:center;">
                        <hr>
                        HBUHSD Help Desk via Flask and Twitter Bootstrap on Python/Google App Engine
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

