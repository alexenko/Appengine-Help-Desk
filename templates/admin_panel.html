<!doctype html>
<html>
    <head>
        <title>HBUHSD Help Desk</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="/static/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="/static/js/jquery-ui-1.8.20.custom.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap-modal.js"></script>
        <script type="text/javascript" src="/static/js/bootstrap-tooltip.js"></script>
        <script type="text/javascript" src="/static/js/underscore-min.js"></script>
        <script type="text/javascript" src="/static/js/backbone-min.js"></script>
        <script type="text/javascript" src="/static/js/handlebars.js"></script>
        <script type="text/javascript" src="/static/js/chosen.jquery.min.js"></script>

        <script type="text/javascript" src="/static/js/admin_panel.js"></script>

        <link rel="shortcut icon" href="/static/favicon.ico" />
        <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/static/css/bootstrap-responsive.min.css" />
        <link rel="stylesheet" href="/static/css/jquery-ui-1.8.20.custom.css" />
        <link rel="stylesheet" href="/static/css/chosen.css" />

        <link rel="stylesheet" href="/static/css/help_desk.css" />

        {% raw %}
        <script id="userListTemplate" type="text/x-handlebars-template">
            <ul id="userList" style="list-style-type:none;">
                {{#each users}}
                <li>{{this.attributes.firstname}} {{this.attributes.lastname}} {{this.attributes.email}} {{this.attributes.ets}} {{this.attributes.nettech}} {{this.attributes.admin}} {{this.attributes.super_admin}}</li>
                {{/each}}
                <li id="addUser"><h6>New User</h6></li>
            </ul>
        </script>

        <script id="newUserTemplate" type="text/x-handlebars-template">
            <li id="newUser">
                <form class="form-inline form-horizontal">
                    <label>First Name: <input id="firstname" class="input-small"></input></label>
                    <label>Last Name: <input id="lastname" class="input-small"></input></label>
                    <label>Email: <input id="email" class="input-small"></input></label>
                    <label>NetTech: <input id="nettech" type="checkbox"></input></label>
                    <label>ETS: <input id="ets" type="checkbox"></input></label>
                    <label>Admin: <input id="admin" type="checkbox"></input></label>
                    <label>Site: 
                        <select>
                            <option>Option</option>
                        </select>
                    </label>
                    <i id="confirmNewUser" class="icon-ok"></i>
                    <i id="cancelNewUser" class="icon-remove"></i>
                </form>
            </li>
        </script>
        {% endraw %}

        <script>
            function Checked(e){
                if (e.attr('checked')){
                    return true;
                } else {
                    return false;
                }
            }

            // single user model
            var User = Backbone.Model.extend({
                urlRoot: function(){
                    var self = this;
                    if (self.get("id")){
                        return '/user';
                    } else {
                        return '/user/'+'new';
                    }
                },
                initialize: function(){
                },
            });

            // users collection
            var Users = Backbone.Collection.extend({
                model: User,
                url: "/users",
                initialize: function(){
                },
            });

            // main app view
            var AdminPanel = Backbone.View.extend({
                users: new Users(),
                events: {
                    "click .adminMe": "adminMe",
                    "click .etsMe": "etsMe",
                    "click .nettechMe": "nettechMe",
                    "click #cancelNewUser": "render",
                    "dblclick #addUser": "getUser",
                    "keypress #newUser": "addUser",
                    "click #confirmNewUser": "addUser",
                },
                initialize: function(){
                    var self = this;

                    self.users.bind('all', self.render, self);
                    self.users.fetch();
                    self.render();
                },
                render: function(){
                    var self = this;
                    var source = $('#userListTemplate').html();
                    var template = Handlebars.compile(source);
                    var context = {
                        users: self.users.models,
                    };
                    var source = template(context);
                    $(self.el).html(source);
                    return self;
                },
                getUser: function(){
                    var self = this;
                    $('#addUser', self.el).remove();
                    var source = $('#newUserTemplate').html();
                    var template = Handlebars.compile(source);
                    var source = template();
                    $('#userList', self.el).append(source);
                    $('#newUser').focus();
                },
                addUser: function(e){
                    console.log(e);
                    var self = this;
                    var firstname = $('#firstname', self.el).val();
                    var lastname = $('#lastname', self.el).val();
                    var email = $('#email', self.el).val();
                    var nettech = Checked($('#nettech', self.el));
                    var admin = Checked($('#admin', self.el));
                    var ets = Checked($('#ets', self.el));
                    var informationSet = (firstname !== '' && lastname !== '' && email.indexOf('@') !== -1);
                    var permissionsSet = (admin || ets || nettech);
                    if (e.keyCode === 27){
                        self.render();
                        return;
                    }
                    if (e.type !== "click" &&(!informationSet || !permissionsSet || e.keyCode !== 13)){
                        return;
                    }
                    var newUser = new User({
                        'firstname': firstname,
                        'lastname': lastname,
                        'email': email,
                        'nettech': nettech,
                        'admin': admin,
                        'ets': ets,
                    });
                    newUser.save();
                    self.users.fetch();
                    self.render();
                },
                adminMe: function(e){
                    console.log(e);
                },
                etsMe: function(e){
                    console.log(e);
                },
                nettechMe: function(e){
                    console.log(e);
                },
            });

            $(document).ready(function(){
                adminPanel = new AdminPanel({
                    el: $("#mainUserList"),
                });
            });
        </script>
    </head>
    <body>
        <div class="container" style="margin-top:50px;">
            <div id="layoutAppHeader" class="row" style="border-radius:15px;border-bottom:10px solid #08c;border-top:10px solid #08c;">
                <div id="titleBlock" class="span8">
                    <h3>Admin Panel</h3>
                    <h6>From here you can add, remove, and modify users and the permissions that they have to the help desk application.</h6>
                </div>
            </div>
            <div class="row" style="margin-top:10px;">
                <div id="mainUserList" class="span12">
                </div>
            </div>
            <div class="row">
                <div id="layoutFooter">
                    <div class="footer" style="text-align:center;">
                        <hr>
                        GAE Help Desk via Flask Backbone.js Handlebars.js Twitter Bootstrap on Python/Google App Engine
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>

